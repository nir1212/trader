# Database Guide - Persistent Trading Data

## ğŸ‰ What Changed

Your trading bot now has **persistent storage**! All your trading data is saved to a SQLite database, so nothing is lost when you restart the bot.

## ğŸ—„ï¸ What Gets Saved

### 1. **Portfolios**
- Portfolio name and ID
- Initial capital
- Current cash and total value
- Creation and update timestamps
- Active/inactive status

### 2. **Trades**
- Every buy and sell order
- Timestamp, symbol, quantity, price
- Trade action (BUY, SELL, STOP_LOSS, TAKE_PROFIT)
- Strategy that generated the trade
- Commission costs

### 3. **Portfolio Snapshots**
- Historical portfolio values
- Taken at regular intervals
- Track performance over time
- Cash vs positions breakdown

### 4. **Trading Signals**
- All signals generated by strategies
- BUY, SELL, or HOLD recommendations
- Which strategy generated it
- Whether it was executed
- Confidence level

### 5. **Positions**
- Current open positions
- Entry price and current price
- Stop-loss and take-profit levels
- Position history (when opened/closed)

### 6. **Performance Metrics**
- Win rate, Sharpe ratio, max drawdown
- Total return and return percentage
- Winning vs losing trades
- Average win/loss amounts

## ğŸ“Š Database Schema

```
portfolios
â”œâ”€â”€ id (primary key)
â”œâ”€â”€ name
â”œâ”€â”€ initial_capital
â”œâ”€â”€ current_cash
â”œâ”€â”€ total_value
â”œâ”€â”€ created_at
â”œâ”€â”€ updated_at
â””â”€â”€ is_active

trades
â”œâ”€â”€ id (primary key)
â”œâ”€â”€ portfolio_id (foreign key)
â”œâ”€â”€ timestamp
â”œâ”€â”€ symbol
â”œâ”€â”€ action (BUY/SELL/STOP_LOSS/TAKE_PROFIT)
â”œâ”€â”€ quantity
â”œâ”€â”€ price
â”œâ”€â”€ value
â”œâ”€â”€ commission
â”œâ”€â”€ strategy_name
â””â”€â”€ bot_name

portfolio_snapshots
â”œâ”€â”€ id (primary key)
â”œâ”€â”€ portfolio_id (foreign key)
â”œâ”€â”€ timestamp
â”œâ”€â”€ total_value
â”œâ”€â”€ cash
â”œâ”€â”€ positions_value
â”œâ”€â”€ total_pnl
â”œâ”€â”€ total_pnl_pct
â””â”€â”€ num_positions

signals
â”œâ”€â”€ id (primary key)
â”œâ”€â”€ timestamp
â”œâ”€â”€ symbol
â”œâ”€â”€ signal_type (BUY/SELL/HOLD)
â”œâ”€â”€ strategy_name
â”œâ”€â”€ price
â”œâ”€â”€ confidence
â”œâ”€â”€ executed
â””â”€â”€ signal_metadata (JSON)

positions
â”œâ”€â”€ id (primary key)
â”œâ”€â”€ portfolio_id (foreign key)
â”œâ”€â”€ symbol
â”œâ”€â”€ quantity
â”œâ”€â”€ entry_price
â”œâ”€â”€ current_price
â”œâ”€â”€ entry_time
â”œâ”€â”€ stop_loss
â”œâ”€â”€ take_profit
â”œâ”€â”€ position_type (LONG/SHORT)
â”œâ”€â”€ is_open
â””â”€â”€ closed_at

performance
â”œâ”€â”€ id (primary key)
â”œâ”€â”€ portfolio_id (foreign key)
â”œâ”€â”€ timestamp
â”œâ”€â”€ period (daily/weekly/monthly/all_time)
â”œâ”€â”€ total_return
â”œâ”€â”€ total_return_pct
â”œâ”€â”€ sharpe_ratio
â”œâ”€â”€ max_drawdown
â”œâ”€â”€ win_rate
â”œâ”€â”€ total_trades
â”œâ”€â”€ winning_trades
â”œâ”€â”€ losing_trades
â”œâ”€â”€ avg_win
â”œâ”€â”€ avg_loss
â””â”€â”€ profit_factor
```

## ğŸš€ How to Use

### **Option 1: Use PortfolioWithDB (Recommended)**

```python
from trader.core.portfolio_with_db import PortfolioWithDB
from trader.database.db_manager import DatabaseManager

# Initialize database
db_manager = DatabaseManager("data/trading_bot.db")

# Create or load portfolio
portfolio = PortfolioWithDB(
    initial_capital=10000,
    name="my_portfolio",
    db_manager=db_manager
)

# Everything is automatically saved!
# Trades, snapshots, positions all persist
```

### **Option 2: Use DatabaseManager Directly**

```python
from trader.database.db_manager import DatabaseManager

db = DatabaseManager("data/trading_bot.db")

# Create portfolio
portfolio = db.create_portfolio("my_portfolio", 10000)

# Record trades
trade = db.record_trade(
    portfolio_id=portfolio.id,
    symbol="AAPL",
    action="BUY",
    quantity=10,
    price=150.00,
    value=1500.00,
    strategy_name="Moving Average"
)

# Save snapshots
snapshot = db.save_snapshot(
    portfolio_id=portfolio.id,
    total_value=10500,
    cash=8500,
    positions_value=2000,
    total_pnl=500,
    total_pnl_pct=5.0,
    num_positions=2
)

# Record signals
signal = db.record_signal(
    symbol="AAPL",
    signal_type="BUY",
    strategy_name="RSI Strategy",
    price=150.00,
    confidence=0.85,
    executed=True
)
```

## ğŸ“ˆ Querying Data

### **Get Trade History**

```python
# Get all trades for a portfolio
trades = db.get_trades(portfolio_id=1)

# Filter by symbol
trades = db.get_trades(portfolio_id=1, symbol="AAPL")

# Filter by date range
from datetime import datetime, timedelta
start = datetime.now() - timedelta(days=7)
trades = db.get_trades(portfolio_id=1, start_date=start)

# Limit results
trades = db.get_trades(portfolio_id=1, limit=10)
```

### **Get Portfolio Snapshots**

```python
# Get all snapshots
snapshots = db.get_snapshots(portfolio_id=1)

# Get recent snapshots
snapshots = db.get_snapshots(portfolio_id=1, limit=20)

# Filter by date
snapshots = db.get_snapshots(
    portfolio_id=1,
    start_date=start_date,
    end_date=end_date
)
```

### **Get Trading Signals**

```python
# Get all signals
signals = db.get_signals()

# Filter by symbol
signals = db.get_signals(symbol="AAPL")

# Filter by signal type
signals = db.get_signals(signal_type="BUY")

# Filter by strategy
signals = db.get_signals(strategy_name="RSI Strategy")
```

### **Get Portfolio Statistics**

```python
stats = db.get_portfolio_stats(portfolio_id=1)

# Returns:
# {
#     'portfolio_name': 'my_portfolio',
#     'initial_capital': 10000,
#     'current_value': 10500,
#     'total_pnl': 500,
#     'total_pnl_pct': 5.0,
#     'total_trades': 10,
#     'buy_trades': 5,
#     'sell_trades': 5,
#     'winning_trades': 3,
#     'losing_trades': 2,
#     'win_rate': 60.0
# }
```

## ğŸ› ï¸ Available Scripts

### **1. example_with_database.py**
Run your bot with database persistence
```bash
poetry run python example_with_database.py
```

### **2. view_database.py**
View all data in your database
```bash
poetry run python view_database.py
```

## ğŸ’¡ Key Features

### **Automatic Persistence**
- When using `PortfolioWithDB`, everything is saved automatically
- Trades recorded on every buy/sell
- Snapshots saved after each position change
- Positions tracked in real-time

### **Resume Trading**
- Bot remembers your portfolio state
- Can stop and restart without losing data
- Positions persist between sessions

### **Historical Analysis**
- View all past trades
- Track portfolio value over time
- Analyze which strategies work best
- Calculate performance metrics

### **Data Integrity**
- SQLite database with ACID properties
- Foreign key relationships
- Indexed columns for fast queries
- Timestamps on all records

## ğŸ“ Database Location

Default: `data/trading_bot.db`

You can specify a different location:
```python
db = DatabaseManager("path/to/your/database.db")
```

## ğŸ” Viewing the Database

### **Option 1: Use view_database.py**
```bash
poetry run python view_database.py
```

### **Option 2: Use SQLite Browser**
Download [DB Browser for SQLite](https://sqlitebrowser.org/)
Open `data/trading_bot.db`

### **Option 3: Command Line**
```bash
sqlite3 data/trading_bot.db
.tables
SELECT * FROM trades LIMIT 10;
```

## ğŸ“Š Example Queries

### **Best Performing Trades**
```python
session = db.get_session()
trades = session.query(Trade).order_by(Trade.value.desc()).limit(10).all()
```

### **Portfolio Value Over Time**
```python
snapshots = db.get_snapshots(portfolio_id=1)
for snap in snapshots:
    print(f"{snap.timestamp}: ${snap.total_value:.2f}")
```

### **Win Rate by Strategy**
```python
trades = db.get_trades(portfolio_id=1)
# Group by strategy_name and calculate win rate
```

## ğŸ¯ Integration with Existing Code

### **Update Your Bot to Use Database**

Before:
```python
from trader.core.portfolio import Portfolio

portfolio = Portfolio(10000)
```

After:
```python
from trader.core.portfolio_with_db import PortfolioWithDB
from trader.database.db_manager import DatabaseManager

db_manager = DatabaseManager()
portfolio = PortfolioWithDB(10000, "my_portfolio", db_manager)
```

That's it! Everything else works the same, but now it's persistent.

## âš ï¸ Important Notes

1. **Backup Your Database**
   - The database file contains all your trading history
   - Back it up regularly: `cp data/trading_bot.db data/backup.db`

2. **Database Size**
   - SQLite can handle millions of records
   - Typical usage: ~1MB per 1000 trades
   - No maintenance required

3. **Concurrent Access**
   - SQLite handles multiple readers
   - Only one writer at a time
   - Fine for single-bot usage

4. **Migration**
   - If you change the schema, you may need to recreate the database
   - Or use Alembic for migrations (advanced)

## ğŸš€ Next Steps

1. **Run the example**
   ```bash
   poetry run python example_with_database.py
   ```

2. **View your data**
   ```bash
   poetry run python view_database.py
   ```

3. **Update your existing scripts**
   - Replace `Portfolio` with `PortfolioWithDB`
   - Add `DatabaseManager` initialization

4. **Analyze your performance**
   - Use the query methods to analyze trades
   - Track your win rate over time
   - See which strategies perform best

## ğŸ“š Additional Resources

- **SQLAlchemy Docs**: https://docs.sqlalchemy.org/
- **SQLite Docs**: https://www.sqlite.org/docs.html
- **DB Browser**: https://sqlitebrowser.org/

Your trading bot is now enterprise-grade with full data persistence! ğŸ‰
